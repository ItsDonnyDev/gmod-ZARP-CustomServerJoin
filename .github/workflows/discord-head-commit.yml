name: Discord notify

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post all commits (plus merge) in order
        env:
          WEBHOOK:        ${{ secrets.DISCORD_NOTIFY }}
          REPO:           ${{ github.repository }}
          BRANCH:         ${{ github.ref_name }}
          COMMITS_JSON:   ${{ toJson(github.event.commits) }}
          HEAD_JSON:      ${{ toJson(github.event.head_commit) }}
          ACTOR_FALLBACK: ${{ github.actor }}
        shell: bash
        run: |
          set -euo pipefail

          # Normalize inputs
          echo "${COMMITS_JSON:-[]}" | jq 'if .==null then [] else . end' > commits.json
          echo "${HEAD_JSON:-null}"   | jq '.' > head.json

          # Combine commits + head_commit, de-dup by id, sort by timestamp
          jq -cs '
            (.[0] // []) + (if .[1]==null or .[1]=={} then [] else [.[1]] end)
            | map(select(.id?))
            | unique_by(.id)
            | sort_by(.timestamp // "")
          ' commits.json head.json > list.json

          repo_short="$(awk -F/ '{print ($2?$2:$0)}' <<< "$REPO")"

          jq -c '.[] | {id, message, timestamp, author}' list.json | while read -r c; do
            msg="$(jq -r '.message // ""' <<< "$c")"
            ts="$(jq -r '.timestamp // empty' <<< "$c")"
            login="$(jq -r '.author.username // empty' <<< "$c")"
            [ -z "$login" ] && login="$ACTOR_FALLBACK"

            # Time handling
            if [ -z "$ts" ] || ! date -d "$ts" >/dev/null 2>&1; then ts="$(date -Iseconds)"; fi
            c_date="$(date -u -d "$ts" +"%Y-%m-%d")"
            n_date="$(date -u +"%Y-%m-%d")"
            time_str="$(date -d "$ts" +"%-H:%M")"
            if [ "$c_date" = "$n_date" ]; then
              foot_extra="Today $time_str"
            else
              date_str="$(date -d "$ts" +"%d/%m/%Y")"
              foot_extra="$date_str $time_str"
            fi
            iso_utc="$(date -u -d "$ts" +"%Y-%m-%dT%H:%M:%SZ")"

            jq -n \
              --arg login "$login" \
              --arg msg "$msg" \
              --arg repo "$repo_short" \
              --arg branch "$BRANCH" \
              --arg foot "$repo_short - $BRANCH â€¢ $foot_extra" \
              --arg iso "$iso_utc" \
              '{
                username: "GitHub",
                avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                embeds: [{
                  color: 3113463,
                  author: {
                    name: $login,
                    url: ("https://github.com/" + $login),
                    icon_url: ("https://avatars.githubusercontent.com/" + $login)
                  },
                  description: $msg,
                  footer: { text: $foot },
                  timestamp: $iso
                }]
              }' \
            | curl -fsS -H 'Content-Type: application/json' -d @- "$WEBHOOK" >/dev/null
          done
